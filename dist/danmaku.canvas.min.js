!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Danmaku=e()}(this,(function(){"use strict";!function(){for(var t=["oTransform","msTransform","mozTransform","webkitTransform","transform"],e=document.createElement("div").style,i=0;i<t.length;i++)if(t[i]in e)return t[i]}();var t=Object.create(null);function e(e,i){if("function"==typeof e.render){var n=e.render();if(n instanceof HTMLCanvasElement)return e.width=n.width,e.height=n.height,n}var s=document.createElement("canvas"),h=s.getContext("2d"),r=e.style||{};r.font=r.font||"10px sans-serif",r.textBaseline=r.textBaseline||"bottom";var a=1*r.lineWidth;for(var o in a=a>0&&a!==1/0?Math.ceil(a):1*!!r.strokeStyle,h.font=r.font,e.width=e.width||Math.max(1,Math.ceil(h.measureText(e.text).width)+2*a),e.height=e.height||Math.ceil(function(e,i){if(t[e])return t[e];var n=12,s=e.match(/(\d+(?:\.\d+)?)(px|%|em|rem)(?:\s*\/\s*(\d+(?:\.\d+)?)(px|%|em|rem)?)?/);if(s){var h=1*s[1]||10,r=s[2],a=1*s[3]||1.2,o=s[4];"%"===r&&(h*=i.container/100),"em"===r&&(h*=i.container),"rem"===r&&(h*=i.root),"px"===o&&(n=a),"%"===o&&(n=h*a/100),"em"===o&&(n=h*a),"rem"===o&&(n=i.root*a),void 0===o&&(n=h*a)}return t[e]=n,n}(r.font,i))+2*a,s.width=e.width,s.height=e.height,r)h[o]=r[o];var m=0;switch(r.textBaseline){case"top":case"hanging":m=a;break;case"middle":m=e.height>>1;break;default:m=e.height-a}return r.strokeStyle&&h.strokeText(e.text,a,m),h.fillText(e.text,a,m),s}function i(t){return 1*window.getComputedStyle(t,null).getPropertyValue("font-size").match(/(.+)px/)[1]}var n={name:"canvas",init:function(t){var e=document.createElement("canvas");return e.context=e.getContext("2d"),e._fontSize={root:i(document.getElementsByTagName("html")[0]),container:i(t)},e},clear:function(t,e){t.context.clearRect(0,0,t.width,t.height);for(var i=0;i<e.length;i++)e[i].canvas=null},resize:function(){},framing:function(t){t.context.clearRect(0,0,t.width,t.height)},setup:function(t,i){for(var n=0;n<i.length;n++){var s=i[n];s.canvas=e(s,t._fontSize)}},render:function(t,e){t.context.drawImage(e.canvas,e.x,e.y)},remove:function(t,e){e.canvas=null}};function s(t){var e=this,i=this.media?this.media.currentTime:Date.now()/1e3,n=this.media?this.media.playbackRate:1;function s(t,s){if("top"===s.mode||"bottom"===s.mode)return i-t.time<e._.duration;var h=(e._.stage.width+t.width)*(i-t.time)*n/e._.duration;if(t.width>h)return!0;var r=e._.duration+t.time-i,a=e._.stage.width+s.width,o=e.media?s.time:s._utc,m=a*(i-o)*n/e._.duration,u=e._.stage.width-m;return r>e._.duration*u/(e._.stage.width+s.width)}for(var h=this._.space[t.mode],r=0,a=0,o=1;o<h.length;o++){var m=h[o],u=t.height;if("top"!==t.mode&&"bottom"!==t.mode||(u+=m.height),m.range-m.height-h[r].range>=u){a=o;break}s(m,t)&&(r=o)}var d=h[r].range,c={range:d+t.height,time:this.media?t.time:t._utc,width:t.width,height:t.height};return h.splice(r+1,a-r-1,c),"bottom"===t.mode?this._.stage.height-t.height-d%this._.stage.height:d%(this._.stage.height-t.height)}var h=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(t){return setTimeout(t,50/3)},r=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||clearTimeout;function a(t,e,i){for(var n=0,s=0,h=t.length;s<h-1;)i>=t[n=s+h>>1][e]?s=n:h=n;return t[s]&&i<t[s][e]?s:h}function o(t){return/^(ltr|top|bottom)$/i.test(t)?t.toLowerCase():"rtl"}function m(){var t=9007199254740991;return[{range:0,time:-t,width:t,height:0},{range:t,time:t,width:0,height:0}]}function u(t){t.ltr=m(),t.rtl=m(),t.top=m(),t.bottom=m()}function d(){if(!this._.visible||!this._.paused)return this;if(this._.paused=!1,this.media)for(var t=0;t<this._.runningList.length;t++){var e=this._.runningList[t];e._utc=Date.now()/1e3-(this.media.currentTime-e.time)}var i=this,n=function(t,e,i,n){return function(){t(this._.stage);var h=Date.now()/1e3,r=this.media?this.media.currentTime:h,a=this.media?this.media.playbackRate:1,o=null,m=0,u=0;for(u=this._.runningList.length-1;u>=0;u--)o=this._.runningList[u],r-(m=this.media?o.time:o._utc)>this._.duration&&(n(this._.stage,o),this._.runningList.splice(u,1));for(var d=[];this._.position<this.comments.length&&(o=this.comments[this._.position],!((m=this.media?o.time:o._utc)>=r));)r-m>this._.duration||(this.media&&(o._utc=h-(this.media.currentTime-o.time)),d.push(o)),++this._.position;for(e(this._.stage,d),u=0;u<d.length;u++)(o=d[u]).y=s.call(this,o),"top"!==o.mode&&"bottom"!==o.mode||(o.x=this._.stage.width-o.width>>1),this._.runningList.push(o);for(u=0;u<this._.runningList.length;u++){o=this._.runningList[u];var c=(this._.stage.width+o.width)*(h-o._utc)*a/this._.duration;"ltr"===o.mode&&(o.x=c-o.width+.5|0),"rtl"===o.mode&&(o.x=this._.stage.width-c+.5|0),i(this._.stage,o)}}}(this._.engine.framing.bind(this),this._.engine.setup.bind(this),this._.engine.render.bind(this),this._.engine.remove.bind(this));return this._.requestID=h((function t(){n.call(i),i._.requestID=h(t)})),this}function c(){return!this._.visible||this._.paused||(this._.paused=!0,r(this._.requestID),this._.requestID=0),this}function l(){if(!this.media)return this;this.clear(),u(this._.space);var t=a(this.comments,"time",this.media.currentTime);return this._.position=Math.max(0,t-1),this}function g(t){t.play=d.bind(this),t.pause=c.bind(this),t.seeking=l.bind(this),this.media.addEventListener("play",t.play),this.media.addEventListener("pause",t.pause),this.media.addEventListener("playing",t.play),this.media.addEventListener("waiting",t.pause),this.media.addEventListener("seeking",t.seeking)}function f(t){this.media.removeEventListener("play",t.play),this.media.removeEventListener("pause",t.pause),this.media.removeEventListener("playing",t.play),this.media.removeEventListener("waiting",t.pause),this.media.removeEventListener("seeking",t.seeking),t.play=null,t.pause=null,t.seeking=null}function _(t){this._={},this.container=t.container||document.createElement("div"),this.media=t.media,this._.visible=!0,this.engine="canvas",this._.engine=n,this._.requestID=0,this._.speed=Math.max(0,t.speed)||144,this._.duration=4,this.comments=t.comments||[],this.comments.sort((function(t,e){return t.time-e.time}));for(var e=0;e<this.comments.length;e++)this.comments[e].mode=o(this.comments[e].mode);return this._.runningList=[],this._.position=0,this._.paused=!0,this.media&&(this._.listener={},g.call(this,this._.listener)),this._.stage=this._.engine.init(this.container),this._.stage.style.cssText+="position:relative;pointer-events:none;",this.resize(),this.container.appendChild(this._.stage),this._.space={},u(this._.space),this.media&&this.media.paused||(l.call(this),d.call(this)),this}function p(){if(!this.container)return this;for(var t in c.call(this),this.clear(),this.container.removeChild(this._.stage),this.media&&f.call(this,this._.listener),this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=null);return this}var v=["mode","time","text","render","style"];function w(t){if(!t||"[object Object]"!==Object.prototype.toString.call(t))return this;for(var e={},i=0;i<v.length;i++)void 0!==t[v[i]]&&(e[v[i]]=t[v[i]]);if(e.text=(e.text||"").toString(),e.mode=o(e.mode),e._utc=Date.now()/1e3,this.media){var n=0;void 0===e.time?(e.time=this.media.currentTime,n=this._.position):(n=a(this.comments,"time",e.time))<this._.position&&(this._.position+=1),this.comments.splice(n,0,e)}else this.comments.push(e);return this}function y(){return this._.visible?this:(this._.visible=!0,this.media&&this.media.paused||(l.call(this),d.call(this)),this)}function b(){return this._.visible?(c.call(this),this.clear(),this._.visible=!1,this):this}function x(){return this._.engine.clear(this._.stage,this._.runningList),this._.runningList=[],this}function L(){return this._.stage.width=this.container.offsetWidth,this._.stage.height=this.container.offsetHeight,this._.engine.resize(this._.stage),this._.duration=this._.stage.width/this._.speed,this}var T={get:function(){return this._.speed},set:function(t){return"number"!=typeof t||isNaN(t)||!isFinite(t)||t<=0?this._.speed:(this._.speed=t,this._.stage.width&&(this._.duration=this._.stage.width/t),t)}};function k(t){t&&_.call(this,t)}return k.prototype.destroy=function(){return p.call(this)},k.prototype.emit=function(t){return w.call(this,t)},k.prototype.show=function(){return y.call(this)},k.prototype.hide=function(){return b.call(this)},k.prototype.clear=function(){return x.call(this)},k.prototype.resize=function(){return L.call(this)},Object.defineProperty(k.prototype,"speed",T),k}));
